---
config:
  interpreter: /bin/bash
  timeout: 3s
checks:
  - exitcode
  - stdout
  - stderr
tests:
  - name: Basics
    tests:
      - name: Install
        config:
          timeout: 15s
        commands:
          - go generate ../...
          - go install -a ..
      - name: Lex
        commands:
          - $(go env GOPATH)/bin/rpc -lex todo-simple.rpc
          - $(go env GOPATH)/bin/rpc -lex todo-complex.rpc
      - name: Parse
        commands:
          - $(go env GOPATH)/bin/rpc -parse todo-simple.rpc
          - $(go env GOPATH)/bin/rpc -parse todo-complex.rpc
  - name: Generators
    commands:
      - rm -r /tmp/rpc >/dev/null 2>&1  || true
    tests:
      - name: Elm
        tests:
          - name: Simple
            commands:
              - $(go env GOPATH)/bin/rpc -gen elm -out /tmp/rpc/elm todo-simple.rpc
              - find /tmp/rpc/elm -name "*.elm"
              - find /tmp/rpc/elm -name "*.elm" | xargs cat
          - name: Complex
            commands:
              - $(go env GOPATH)/bin/rpc -gen elm -out /tmp/rpc/elm todo-complex.rpc
              - find /tmp/rpc/elm -name "*.elm"
              - find /tmp/rpc/elm -name "*.elm" | xargs cat
      - name: Go
        tests:
          - name: Simple
            commands:
              - $(go env GOPATH)/bin/rpc -gen go  -out /tmp/rpc/go todo-simple.rpc
              - find /tmp/rpc/go -name "*.go"
              - find /tmp/rpc/go -name "*.go" | xargs cat
          - name: Complex
            commands:
              - $(go env GOPATH)/bin/rpc -gen go  -out /tmp/rpc/go todo-complex.rpc
              - find /tmp/rpc/go -name "*.go"
              - find /tmp/rpc/go -name "*.go" | xargs cat
  - name: Client<->Server
    config:
      workdir: ./clientserver
    tests:
      - name: Go
        commands:
          - go generate -v ./...
          - go build -o ./bin/clientserver .
          - ./bin/clientserver # prints interaction output
  - name: Examples
    tests:
      - name: todoapp
        config:
          timeout: 20s
          workdir: ../examples/todoapp
        commands:
          - ./build.sh


